<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Emscripten-Generated Code</title>
    <style>
        html,
        body {
            font-family: arial;
            height: 100%;
            margin: 0px;
            padding: 0px;
        }

        #output {
            width: 100%;
            height: 100%;
            margin: 0px;
            border: 0px;
            padding: 0px;
            display: block;
            background-color: black;
            color: white;
            font-family: 'Lucida Console', Monaco, monospace;
            outline: none;
        }
    </style>
</head>

<body>
    <textarea id="output" rows="8"></textarea>
	<div id="inputarea">
		<div id="usermedia" style="display: none;">
			<input type="button" value="Capture" id="captureImg">
		</div>
		<div id="files" style="display: none;">
			<input type="file" accept="image/*;capture=camera" id="imgfile">
		</div>
		<input type="button" id="showFile" value="use files">
		<input type="button" id="showCapture" value="use camera">
		<div>
			<input type="button" id="go" value="go">
		</div>
	</div>
	
	
    <script src="./jquery.min.js"></script>
    <script src="./FileSaver.min.js"></script>
	<script type="text/javascript">
		var init = function () {
			$("#output").hide();
			$("#go").on("click",function () {
				var canvasses = $("canvas");
				for(var i=0;i<canvasses.length;i+=1){
					var data = canvasses[i].toDataURL('image/jpeg', 1.0);
					w.postMessage({
						data: data
					});
				}
				w.postMessage({
					msg: "start"
				});
				$("#inputarea").hide();
				$("#output").show();
				for(var ii=0;ii<streams.length;ii+=1){
					var tracks = streams[ii].getTracks();
					for(var j=0;j<tracks.length;j+=1){
						tracks[j].stop();
					}
				}
				streams = [];
			});
			$("#showFile").on("click",function () {
				$("#files").show();
				$("#usermedia").hide();
				for(var i=0;i<streams.length;i+=1){
					var tracks = streams[i].getTracks();
					for(var j=0;j<tracks.length;j+=1){
						tracks[j].stop();
					}
				}
				streams = [];
			});
			$("#showCapture").on("click",function () {
				$("#files").hide();
				$("#usermedia").show();
				$("video").remove();
				var video = document.createElement('video');
				video.style.width = '612px';
				video.setAttribute('autoplay', '');
				video.setAttribute('muted', '');
				video.setAttribute('playsinline', '');
				var handleVideo = function (stream) {
					video.srcObject = stream;
					streams.push(stream);
					$("#usermedia").append(video);
				};
				var videoError = function(e) {
					console.log("video error: ",e);
				};
				var constraints = {
					facingMode: 'environment'
				};				
				navigator.mediaDevices.getUserMedia({audio: false,video:constraints}).then(handleVideo).catch(videoError);
			});
			var streams = [];
			
			$("#captureImg").on("click",function () {
				var video = $("video")[0];
				var canvas = document.createElement("canvas");
				canvas.width = $(video).width();
				canvas.height = $(video).height();
				var ctx = canvas.getContext('2d');
				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
				$("#inputarea").append(canvas);
			});
			$("#imgfile").on("change",function () {
				var input = $("#imgfile")[0];
				if (!input.files||!input.files[0]) {
					console.log("no file.");
				}
				var file = input.files[0];
				fr = new FileReader();
				fr.onload = function () {
					var img = new Image();
					img.onload = function () {
						img.style.width = '612px';
						var canvas = document.createElement("canvas");
						var w = this.width;
						var h = this.height;
						if(w>612){
							var scale = 612/w;
							h = h*scale;
							w = 612;
						}
						canvas.width = w;
						canvas.height = h;
						var ctx = canvas.getContext("2d");
						ctx.drawImage(img,0,0,canvas.width, canvas.height);
						$("#inputarea").append(canvas)
					};
					img.src = fr.result;
				};
				fr.readAsDataURL(file);
			});
		};
		$(document).ready(init);
	</script>
    <script type='text/javascript'>
        var w;
        var start = function() {
            if (typeof(Worker) !== "undefined") {
                if (typeof(w) == "undefined") {
                    w = new Worker("openmve_worker.js");
                }
                w.onmessage = function(e) {
                    if (e.data.hasOwnProperty("msg")) {
                        var text = e.data.msg;
                        console.log("main received: " + text);
                        var element = document.getElementById('output');
                        if (element) {
                            element.value += text + "\n";
                            element.scrollTop = element.scrollHeight; // focus on bottom
                        }
                    }
					if (e.data.hasOwnProperty("file")){
                        console.log("main received file: " +  e.data.file);
						var fName = e.data.file;
						var fData = e.data.data;
						 var blob = new Blob([fData], {
							type: "application/octet-binary"
						});
						saveAs(blob, fName);
					}
                };
            } else {
                console.log("Your browser does not support Web Workers");
            }
        };
		start();
    </script>
</body>

</html>